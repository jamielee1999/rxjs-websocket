<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket èŠå¤©å®¤</title>
    <script type="importmap">
      {
        "imports": {
          "rxjs": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs.min.js",
          "rxjs/operators": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs-operators.min.js",
          "rxjs/webSocket": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs-websocket.min.js"
        }
      }
    </script>
    <style>
      .container {
        padding: 40px;
        max-width: 800px;
        margin: 0 auto;
      }
      .chat-area {
        display: flex;
        gap: 20px;
      }
      .chat-box {
        flex: 1;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      .message-list {
        height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .message {
        margin: 5px 0;
        padding: 5px;
        border-radius: 4px;
        clear: both;
        max-width: 70%;
      }
      .user1 {
        background-color: #e3f2fd;
        float: left;
      }
      .user2 {
        background-color: #f5f5f5;
        float: right;
      }
      .input-area {
        display: flex;
        gap: 10px;
      }
      input {
        flex: 1;
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>WebSocket èŠå¤©å®¤</h1>
      <p id="status">ğŸŒ å°šæœªé€£æ¥</p>
      <div class="chat-area">
        <div class="chat-box">
          <h3>èŠå¤©å®¤</h3>
          <div id="messages" class="message-list"></div>
          <div class="input-area">
            <input type="text" id="input1" placeholder="ä½¿ç”¨è€… 1 è¼¸å…¥è¨Šæ¯..." />
            <button type="button" id="send1">ç™¼é€</button>
          </div>
          <div class="input-area" style="margin-top: 10px;">
            <input type="text" id="input2" placeholder="ä½¿ç”¨è€… 2 è¼¸å…¥è¨Šæ¯..." />
            <button type="button" id="send2">ç™¼é€</button>
          </div>
        </div>
      </div>
      <button type="button" id="disconnect-btn" style="margin-top: 20px">
        é—œé–‰é€£ç·š
      </button>
    </div>

    <script type="module">
      import { fromEvent } from 'rxjs';
      import { webSocket } from 'rxjs/webSocket';

      const statusElement = document.querySelector('#status');
      const messages = document.querySelector('#messages');
      const input1 = document.querySelector('#input1');
      const input2 = document.querySelector('#input2');
      const send1 = document.querySelector('#send1');
      const send2 = document.querySelector('#send2');
      const disconnectButton = document.querySelector('#disconnect-btn');

      // å»ºç«‹ WebSocket é€£ç·š
      const ws$ = webSocket('wss://ws.postman-echo.com/raw');

      // è¨‚é–± WebSocket è¨Šæ¯
      ws$.subscribe({
        next: (msg) => {
          if (typeof msg === 'string') {
            const [user, message] = msg.split(':');
            const messageElement = document.createElement('div');
            messageElement.textContent = `${user === 'user1' ? 'ä½¿ç”¨è€… 1' : 'ä½¿ç”¨è€… 2'}: ${message}`;
            messageElement.classList.add('message');
            messageElement.classList.add(user);
            messages.appendChild(messageElement);
            
            // è‡ªå‹•æ²å‹•åˆ°æœ€æ–°è¨Šæ¯
            messages.scrollTop = messages.scrollHeight;
          }
          statusElement.textContent = 'ğŸŸ¢ WebSocket é€£ç·šå·²å»ºç«‹';
        },
        error: (error) => {
          statusElement.textContent = `âŒ WebSocket éŒ¯èª¤: ${error.message}`;
          statusElement.style.color = 'red';
        },
        complete: () => {
          statusElement.textContent = 'ğŸ”´ WebSocket é€£ç·šå·²é—œé–‰';
        }
      });

      // è™•ç†ç™¼é€è¨Šæ¯
      function sendMessage(user, input) {
        const message = input.value.trim();
        if (message) {
          ws$.next(`${user}:${message}`);
          input.value = '';
        }
      }

      // ç¶å®šç™¼é€æŒ‰éˆ•äº‹ä»¶
      fromEvent(send1, 'click').subscribe(() => sendMessage('user1', input1));
      fromEvent(send2, 'click').subscribe(() => sendMessage('user2', input2));

      // ç¶å®š Enter éµäº‹ä»¶
      fromEvent(input1, 'keypress').subscribe(event => {
        if (event.key === 'Enter') {
          sendMessage('user1', input1);
        }
      });
      fromEvent(input2, 'keypress').subscribe(event => {
        if (event.key === 'Enter') {
          sendMessage('user2', input2);
        }
      });

      // é—œé–‰é€£ç·š
      fromEvent(disconnectButton, 'click').subscribe(() => {
        ws$.complete();
      });
    </script>
  </body>
</html>
