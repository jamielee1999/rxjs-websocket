<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- æ”¹ç”¨ ESM ç‰ˆæœ¬çš„ RxJS CDN -->
    <script type="importmap">
    {
      "imports": {
        "rxjs": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs.min.js",
        "rxjs/operators": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs-operators.min.js",
        "rxjs/webSocket": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs-websocket.min.js"
      }
    }
    </script>
  </head>
  <body>
    <h1>WebSocket è¨Šæ¯</h1>
    <p id="message"></p>
    <p id="status"></p>

    <script type="module">
      import { interval, Subject } from 'rxjs';
      import { retry, takeUntil, take, map, filter, debounceTime } from 'rxjs/operators';
      import { webSocket } from 'rxjs/webSocket';

      const messageElement = document.querySelector('#message');
      const statusElement = document.querySelector('#status');

      // å»ºç«‹ postman-echo Websocket é€£ç·š
      const ws$ = webSocket('wss://ws.postman-echo.com/raw');

      // è¨‚é–±å³æ™‚è¨Šæ¯
      const subscription = ws$.subscribe({
        next: (msg) => {
          messageElement.textContent = `ğŸ“© æ”¶åˆ°è¨Šæ¯: ${msg}`;
        },
        error: (error) => {
          statusElement.textContent = `âŒ WebSocket éŒ¯èª¤: ${error.message}`;
          statusElement.style.color = 'red';
        },
        complete: () => {
          statusElement.textContent = 'ğŸ”´ WebSocket é€£ç·šå·²é—œé–‰';
        },
      });

      // 1. ç¯©é¸å‡ºé‡è¦è¨Šæ¯
      ws$
        .pipe(
          map((msg) => `ğŸ“¢ è¨Šæ¯: ${msg}`),
          // filter((msg) => msg.includes('é‡è¦')),
          debounceTime(200)
        )
        .subscribe((filteredMsg) => {
          const p = document.createElement('p');
          p.textContent = filteredMsg;
          p.style.color = 'blue';
          document.body.appendChild(p);
        });

      // 2. ä½¿ç”¨ interval æ¯å…©ç§’ç™¼é€ä¸€æ¢è¨Šæ¯
      const messages = [
        'Hello from RxJS WebSocket!',
        'é‡è¦è¨Šæ¯ from Joyce',
        'é‡è¦è¨Šæ¯ from Hilo',
        'nonsense',
        'Hello again!',
        'é‡è¦è¨Šæ¯ from Andy',
      ];

      let messageIndex = 0;
      interval(2000)
        .pipe(
          take(messages.length) // åªå–å‰ N æ¬¡ï¼ˆN = messages.lengthï¼‰
        )
        .subscribe({
          next: () => {
            ws$.next(messages[messageIndex]);
            messageIndex++;
          },
          complete: () => {
            statusElement.textContent = 'ğŸ”´ æ‰€æœ‰è¨Šæ¯å·²ç™¼é€å®Œç•¢';
          },
        });
    </script>
  </body>
</html>
