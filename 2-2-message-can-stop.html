<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- æ”¹ç”¨ ESM ç‰ˆæœ¬çš„ RxJS CDN -->
    <script type="importmap">
      {
        "imports": {
          "rxjs": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs.min.js",
          "rxjs/operators": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs-operators.min.js",
          "rxjs/webSocket": "https://unpkg.com/@esm-bundle/rxjs/esm/es2015/rxjs-websocket.min.js"
        }
      }
    </script>
  </head>
  <body>
    <div class="container" style="padding: 40px">
      <h1>WebSocket è¨Šæ¯</h1>
      <p id="message">âœ‰ï¸ ç„¡è¨Šæ¯</p>
      <p id="status">ğŸŒ å°šæœªé€£æ¥</p>
      <button type="button" id="disconnect-btn" style="display: flex">
        é—œé–‰é€£ç·š
      </button>
    </div>

    <script>
      const container = document.querySelector('.container');
      const messageElement = document.querySelector('#message');
      const statusElement = document.querySelector('#status');
      const disconnectButton = document.querySelector('#disconnect-btn');
    </script>

    <script type="module">
      import { interval, Subject } from 'rxjs';
      import {
        retry,
        takeUntil,
        take,
        map,
        filter,
        debounceTime,
      } from 'rxjs/operators';
      import { webSocket } from 'rxjs/webSocket';
      import { fromEvent } from 'rxjs';

      let isMsgComplete = false;

      // 1. å»ºç«‹ postman-echo Websocket é€£ç·š
      const ws$ = webSocket('wss://ws.postman-echo.com/raw');

      // 2. è¨‚é–±å³æ™‚è¨Šæ¯
      const subscription = ws$.subscribe({
        next: (msg) => {
          messageElement.textContent = `ğŸ“© æ”¶åˆ°è¨Šæ¯: ${msg}`;
          if (!isMsgComplete) {
            statusElement.textContent = 'ğŸŸ¢ WebSocket é€£ç·šå·²å»ºç«‹';
          }
        },
        error: (error) => {
          statusElement.textContent = `âŒ WebSocket éŒ¯èª¤: ${error.message}`;
          statusElement.style.color = 'red';
        },
        complete: () => {
          statusElement.textContent = 'ğŸ”´ WebSocket é€£ç·šå·²é—œé–‰';
        },
      });

      // 1. ç¯©é¸å‡ºé‡è¦è¨Šæ¯
      ws$
        .pipe(
          map((msg) => `ğŸ“¢ è¨Šæ¯: ${msg}`),
          filter((msg) => msg.includes('é‡è¦')),
          debounceTime(200)
        )
        .subscribe((filteredMsg) => {
          const p = document.createElement('p');
          p.textContent = filteredMsg;
          p.style.color = 'blue';
          container.appendChild(p);
        });

      // 2. ä½¿ç”¨ interval æ¯å…©ç§’ç™¼é€ä¸€æ¢è¨Šæ¯
      const messages = [
        'Hello from RxJS WebSocket!',
        'é‡è¦è¨Šæ¯ from Joyce',
        'é‡è¦è¨Šæ¯ from Hilo',
        'nonsense',
        'Hello again!',
        'é‡è¦è¨Šæ¯ from Andy',
      ];

      let messageIndex = 0;

      interval(2000)
        .pipe(
          take(messages.length) // åªå–å‰ N æ¬¡ï¼ˆN = messages.lengthï¼‰
        )
        .subscribe({
          next: () => {
            ws$.next(messages[messageIndex]);
            messageIndex++;
          },
          complete: () => {
            if (statusElement.textContent !== 'ğŸ”´ WebSocket é€£ç·šå·²é—œé–‰') {
              isMsgComplete = true;
              statusElement.textContent = 'ğŸ”´ æ‰€æœ‰è¨Šæ¯å·²ç™¼é€å®Œç•¢';
            }
          },
        });

      // 3. é»æ“ŠæŒ‰éˆ•é—œé–‰é€£ç·š
      const click$ = fromEvent(disconnectButton, 'click');

      click$.subscribe(() => {
        console.log('click');
        ws$.complete();
      });
    </script>
  </body>
</html>
